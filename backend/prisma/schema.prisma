// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== AUTENTICAÇÃO ====================

model Usuario {
  id        String   @id @default(uuid())
  nome      String
  login     String   @unique
  email     String   @unique
  senha     String   // Hash bcrypt
  role      Role     @default(OPERADOR)
  ativo     Boolean  @default(true)
  
  parceiroId String?
  parceiro   Parceiro? @relation(fields: [parceiroId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relações
  agendamentos     Agendamento[]
  ordensServico    OrdemServico[]
  boxOcupacoes     BoxOcupacao[]
  leads            Lead[]
  
  @@map("usuarios")
}

enum Role {
  ADMIN
  GERENTE
  OPERADOR
  PARCEIRO
}

// ==================== PARCEIROS E EQUIPES ====================

model Parceiro {
  id          String   @id @default(uuid())
  nome        String
  cnpj        String?  @unique
  telefone    String?
  email       String?
  endereco    String?
  ativo       Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relações
  usuarios         Usuario[]
  equipes          Equipe[]
  agendamentos     Agendamento[]
  ordensServico    OrdemServico[]
  
  @@map("parceiros")
}

model Equipe {
  id          String   @id @default(uuid())
  nome        String
  login       String   @unique
  senha       String   // Hash bcrypt
  
  parceiroId  String
  parceiro    Parceiro @relation(fields: [parceiroId], references: [id], onDelete: Cascade)
  
  ativo       Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("equipes")
}

// ==================== CLIENTES E VEÍCULOS ====================

model Cliente {
  id              String   @id @default(uuid())
  nome            String
  email           String?
  telefone        String
  cpfCnpj         String?  @unique
  
  endereco        String?
  cidade          String?
  estado          String?
  cep             String?
  
  ativo           Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relações
  veiculos        Veiculo[]
  agendamentos    Agendamento[]
  ordensServico   OrdemServico[]
  leads           Lead[]
  orcamentos      Orcamento[]
  
  @@map("clientes")
}

model Veiculo {
  id              String   @id @default(uuid())
  placa           String   @unique
  chassi          String?
  
  marca           String
  modelo          String
  fabricante      String?
  anoFabricacao   String?
  anoModelo       String?
  cor             String?
  combustivel     String?
  
  clienteId       String
  cliente         Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relações
  agendamentos    Agendamento[]
  ordensServico   OrdemServico[]
  
  @@map("veiculos")
}

// ==================== AGENDAMENTOS ====================

model Agendamento {
  id                  String          @id @default(uuid())
  
  clienteId           String
  cliente             Cliente         @relation(fields: [clienteId], references: [id])
  
  veiculoId           String?
  veiculo             Veiculo?        @relation(fields: [veiculoId], references: [id])
  
  responsavelId       String
  responsavel         Usuario         @relation(fields: [responsavelId], references: [id])
  
  parceiroId          String?
  parceiro            Parceiro?       @relation(fields: [parceiroId], references: [id])
  
  dataAgendamento     DateTime
  horarioAgendamento  String?
  
  tipoAgendamento     String          // Tipo de serviço
  status              StatusAgenda    @default(CONFIRMADO)
  
  descricaoServico    String?
  observacoes         String?
  quilometragem       String?
  
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  
  // Relações
  ordemServico        OrdemServico?
  
  @@map("agendamentos")
}

enum StatusAgenda {
  CONFIRMADO
  EXECUTANDO
  FINALIZADO
  CANCELADO
}

// ==================== ORDENS DE SERVIÇO ====================

model OrdemServico {
  id                String        @id @default(uuid())
  numeroOS          String        @unique // Auto-incrementado
  
  clienteId         String
  cliente           Cliente       @relation(fields: [clienteId], references: [id])
  
  veiculoId         String
  veiculo           Veiculo       @relation(fields: [veiculoId], references: [id])
  
  responsavelId     String
  responsavel       Usuario       @relation(fields: [responsavelId], references: [id])
  
  parceiroId        String?
  parceiro          Parceiro?     @relation(fields: [parceiroId], references: [id])
  
  agendamentoId     String?       @unique
  agendamento       Agendamento?  @relation(fields: [agendamentoId], references: [id])
  
  status            StatusOS      @default(AGUARDANDO)
  prioridade        Prioridade    @default(NORMAL)
  
  descricao         String?
  observacoes       String?
  quilometragem     String?
  
  dataAbertura      DateTime      @default(now())
  dataPrevisao      DateTime?
  dataFinalizacao   DateTime?
  
  valorTotal        Decimal?      @db.Decimal(10, 2)
  valorDesconto     Decimal?      @db.Decimal(10, 2)
  
  formaPagamento    String?
  meioPagamento     String?
  origemPedido      OrigemPedido  @default(EXTERNO)
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  // Relações
  itens             ItemOS[]
  boxOcupacoes      BoxOcupacao[]
  historico         HistoricoOS[]
  
  @@map("ordens_servico")
}

enum StatusOS {
  AGUARDANDO
  EM_ATENDIMENTO
  AGUARDANDO_PECAS
  EM_EXECUCAO
  CONCLUIDO
  ENTREGUE
}

enum Prioridade {
  BAIXA
  NORMAL
  ALTA
  URGENTE
}

enum OrigemPedido {
  INTERNO
  EXTERNO
}

model ItemOS {
  id              String       @id @default(uuid())
  
  ordemServicoId  String
  ordemServico    OrdemServico @relation(fields: [ordemServicoId], references: [id], onDelete: Cascade)
  
  tipoItemId      String?
  tipoItem        TipoOSItem?  @relation(fields: [tipoItemId], references: [id])
  
  tipo            TipoItem     // SERVICO ou PRODUTO
  descricao       String
  quantidade      Int          @default(1)
  valorUnitario   Decimal      @db.Decimal(10, 2)
  desconto        Decimal      @default(0) @db.Decimal(10, 2)
  valorTotal      Decimal      @db.Decimal(10, 2)
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@map("itens_os")
}

enum TipoItem {
  SERVICO
  PRODUTO
}

model HistoricoOS {
  id              String       @id @default(uuid())
  
  ordemServicoId  String
  ordemServico    OrdemServico @relation(fields: [ordemServicoId], references: [id], onDelete: Cascade)
  
  statusAnterior  StatusOS?
  statusNovo      StatusOS
  observacao      String?
  
  createdAt       DateTime     @default(now())
  
  @@map("historico_os")
}

// ==================== BOX ====================

model Box {
  id          String        @id @default(uuid())
  numero      String        @unique
  nome        String
  descricao   String?
  ativo       Boolean       @default(true)
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  // Relações
  ocupacoes   BoxOcupacao[]
  
  @@map("boxes")
}

model BoxOcupacao {
  id              String       @id @default(uuid())
  
  boxId           String
  box             Box          @relation(fields: [boxId], references: [id])
  
  ordemServicoId  String
  ordemServico    OrdemServico @relation(fields: [ordemServicoId], references: [id])
  
  responsavelId   String
  responsavel     Usuario      @relation(fields: [responsavelId], references: [id])
  
  dataEntrada     DateTime     @default(now())
  dataSaida       DateTime?
  
  observacoes     String?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@map("box_ocupacoes")
}

// ==================== TIPOS DE OS E ITENS ====================

model TipoOS {
  id          String       @id @default(uuid())
  nome        String       @unique
  descricao   String?
  ativo       Boolean      @default(true)
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  // Relações
  itens       TipoOSItem[]
  
  @@map("tipos_os")
}

model TipoOSItem {
  id          String     @id @default(uuid())
  
  tipoOSId    String
  tipoOS      TipoOS     @relation(fields: [tipoOSId], references: [id], onDelete: Cascade)
  
  nome        String
  tipo        TipoItem   // SERVICO ou PRODUTO
  preco       Decimal    @db.Decimal(10, 2)
  desconto    Decimal    @default(0) @db.Decimal(10, 2)
  duracao     Int?       // Em minutos
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  // Relações
  itensOS     ItemOS[]
  
  @@map("tipos_os_itens")
}

// ==================== CRM ====================

model Lead {
  id              String      @id @default(uuid())
  
  nome            String
  telefone        String
  email           String?
  
  clienteId       String?
  cliente         Cliente?    @relation(fields: [clienteId], references: [id])
  
  origem          String?     // Telefone, Site, WhatsApp, Indicação
  status          StatusLead  @default(NOVO)
  
  observacoes     String?
  
  responsavelId   String?
  responsavel     Usuario?    @relation(fields: [responsavelId], references: [id])
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@map("leads")
}

enum StatusLead {
  NOVO
  CONTATO_REALIZADO
  QUALIFICADO
  CONVERTIDO
  PERDIDO
}

// ==================== ORÇAMENTOS ====================

model Orcamento {
  id              String          @id @default(uuid())
  numeroOrcamento String          @unique
  
  clienteId       String
  cliente         Cliente         @relation(fields: [clienteId], references: [id])
  
  descricao       String?
  valorTotal      Decimal         @db.Decimal(10, 2)
  desconto        Decimal         @default(0) @db.Decimal(10, 2)
  validade        DateTime
  
  status          StatusOrcamento @default(PENDENTE)
  
  observacoes     String?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // Relações
  itens           ItemOrcamento[]
  
  @@map("orcamentos")
}

enum StatusOrcamento {
  PENDENTE
  APROVADO
  REJEITADO
  EXPIRADO
}

model ItemOrcamento {
  id              String     @id @default(uuid())
  
  orcamentoId     String
  orcamento       Orcamento  @relation(fields: [orcamentoId], references: [id], onDelete: Cascade)
  
  descricao       String
  quantidade      Int        @default(1)
  valorUnitario   Decimal    @db.Decimal(10, 2)
  valorTotal      Decimal    @db.Decimal(10, 2)
  
  createdAt       DateTime   @default(now())
  
  @@map("itens_orcamento")
}

// ==================== META E COMISSÃO ====================

model MetaComissao {
  id          String   @id @default(uuid())
  
  nome        String
  descricao   String?
  
  metaValor   Decimal  @db.Decimal(10, 2)
  percentual  Decimal  @db.Decimal(5, 2)
  
  mesReferencia Int    // 1-12
  anoReferencia Int
  
  ativo       Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([mesReferencia, anoReferencia, nome])
  @@map("metas_comissao")
}
